(function(e,t){"object"===typeof exports&&"object"===typeof module?module.exports=t(require("vue")):"function"===typeof define&&define.amd?define([],t):"object"===typeof exports?exports["vue-audio-tapirus"]=t(require("vue")):e["vue-audio-tapirus"]=t(e["Vue"])})("undefined"!==typeof self?self:this,(function(e){return function(){"use strict";var t={262:function(e,t){t.A=(e,t)=>{const s=e.__vccOpts||e;for(const[i,r]of t)s[i]=r;return s}},274:function(t){t.exports=e}},s={};function i(e){var r=s[e];if(void 0!==r)return r.exports;var o=s[e]={exports:{}};return t[e](o,o.exports,i),o.exports}!function(){i.d=function(e,t){for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){i.p=""}();var r={};if(i.d(r,{default:function(){return U}}),"undefined"!==typeof window){var o=window.document.currentScript,n=o&&o.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);n&&(i.p=n[1])}var a=i(274);const c={class:"text-center font-sans w-60 mx-auto"},d={class:"text-sm text-red-400"},l={class:"text-sm text-red-400"};function h(e,t,s,i,r,o){return(0,a.openBlock)(),(0,a.createElementBlock)("div",c,[(0,a.createElementVNode)("div",null,[r.recording?((0,a.openBlock)(),(0,a.createElementBlock)("div",{key:0,style:(0,a.normalizeStyle)({"border-color":s.buttonColor}),class:(0,a.normalizeClass)(o.buttonClass),onClick:t[0]||(t[0]=(...e)=>o.toggleRecording&&o.toggleRecording(...e))},t[2]||(t[2]=[(0,a.createElementVNode)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},[(0,a.createElementVNode)("path",{d:"M0 0h24v24H0z",fill:"none"}),(0,a.createElementVNode)("path",{d:"M6 6h12v12H6z"})],-1)]),6)):((0,a.openBlock)(),(0,a.createElementBlock)("div",{key:1,style:(0,a.normalizeStyle)({"border-color":s.buttonColor}),class:(0,a.normalizeClass)(o.buttonClass),onClick:t[1]||(t[1]=(...e)=>o.toggleRecording&&o.toggleRecording(...e))},t[3]||(t[3]=[(0,a.createElementVNode)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},[(0,a.createElementVNode)("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"}),(0,a.createElementVNode)("path",{d:"M0 0h24v24H0z",fill:"none"})],-1)]),6))]),(0,a.createElementVNode)("div",d,(0,a.toDisplayString)(o.recordedTime),1),(0,a.createElementVNode)("div",l,(0,a.toDisplayString)(r.errorMessage),1)])}class u{constructor(e){this.backendEndpoint=e}async postBackend(e){try{const t=await fetch(this.backendEndpoint,{method:"POST",body:e});return!!t.ok}catch(t){return!1}}}var p=class{constructor(e){this.bufferSize=e.bufferSize||4096,this.sampleRate=e.sampleRate,this.samples=e.samples}finish(){this._joinSamples();const e=new ArrayBuffer(44+2*this.samples.length),t=new DataView(e);this._writeString(t,0,"RIFF"),t.setUint32(4,36+2*this.samples.length,!0),this._writeString(t,8,"WAVE"),this._writeString(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,1,!0),t.setUint32(24,this.sampleRate,!0),t.setUint32(28,4*this.sampleRate,!0),t.setUint16(32,4,!0),t.setUint16(34,16,!0),this._writeString(t,36,"data"),t.setUint32(40,2*this.samples.length,!0),this._floatTo16BitPCM(t,44,this.samples);const s=new Blob([t],{type:"audio/wav"});return{id:Date.now(),blob:s,url:URL.createObjectURL(s)}}_floatTo16BitPCM(e,t,s){for(let i=0;i<s.length;i++,t+=2){const r=Math.max(-1,Math.min(1,s[i]));e.setInt16(t,r<0?32768*r:32767*r,!0)}}_joinSamples(){const e=this.samples.length*this.bufferSize,t=new Float64Array(e);let s=0;for(let i=0;i<this.samples.length;i++){const e=this.samples[i];t.set(e,s),s+=e.length}this.samples=t}_writeString(e,t,s){for(let i=0;i<s.length;i++)e.setUint8(t+i,s.charCodeAt(i))}};function g(e){return e?new Date(1e3*e).toISOString().substr(14,5):null}class m{constructor(e={}){this.beforeRecording=e.beforeRecording,this.pauseRecording=e.pauseRecording,this.afterRecording=e.afterRecording,this.micFailed=e.micFailed,this.encoderOptions={bitRate:e.bitRate,sampleRate:e.sampleRate},this.bufferSize=4096,this.records=[],this.isPause=!1,this.isRecording=!1,this.duration=0,this.volume=0,this.wavSamples=[],this._duration=0}start(){const e={video:!1,audio:{channelCount:1,echoCancellation:!1}};this.beforeRecording&&this.beforeRecording("start recording"),navigator.mediaDevices.getUserMedia(e).then(this._micCaptured.bind(this)).catch(this._micError.bind(this)),this.isPause=!1,this.isRecording=!0}stop(){this.stream.getTracks().forEach((e=>e.stop())),this.input.disconnect(),this.processor.disconnect(),this.context.close();let e=null;const t=new p({bufferSize:this.bufferSize,sampleRate:this.encoderOptions.sampleRate,samples:this.wavSamples});e=t.finish(),this.wavSamples=[],e.duration=g(this.duration),this.records.push(e),this._duration=0,this.duration=0,this.isPause=!1,this.isRecording=!1,this.afterRecording&&this.afterRecording(e)}pause(){this.stream.getTracks().forEach((e=>e.stop())),this.input.disconnect(),this.processor.disconnect(),this._duration=this.duration,this.isPause=!0,this.pauseRecording&&this.pauseRecording("pause recording")}recordList(){return this.records}lastRecord(){return this.records.slice(-1).pop()}_micCaptured(e){this.context=new(window.AudioContext||window.webkitAudioContext),this.duration=this._duration,this.input=this.context.createMediaStreamSource(e),this.processor=this.context.createScriptProcessor(this.bufferSize,1,1),this.stream=e,this.processor.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);let s=0;this.wavSamples.push(new Float32Array(t));for(let i=0;i<t.length;++i)s+=t[i]*t[i];this.duration=parseFloat(this._duration)+parseFloat(this.context.currentTime.toFixed(2)),this.volume=Math.sqrt(s/t.length).toFixed(2)},this.input.connect(this.processor),this.processor.connect(this.context.destination)}_micError(e){this.micFailed&&this.micFailed(e)}}const f="Click icon to start recording message.",b="Click icon again to stop recording.",R="Failed to use microphone. Please refresh and try again and permit the use of a microphone.",w="Successfully recorded message!",v="Successfully submitted audio message! Thank you!",y="Error submitting audio message! Please try again later.";var S={name:"TapirWidget",props:{time:{type:Number,default:1},bitRate:{type:Number,default:128},sampleRate:{type:Number,default:44100},backendEndpoint:{type:String},buttonColor:{type:String,default:"green"},afterRecording:{type:Function},successfulUpload:{type:Function},failedUpload:{type:Function},customUpload:{type:Function,default:null}},data(){return{recording:!1,recordedAudio:null,recordedBlob:null,recorder:null,successMessage:null,errorMessage:null,instructionMessage:f}},computed:{buttonClass(){return"mx-auto h-14 w-14 fill-current text-black cursor-pointer rounded-50 border-2 m-4 p-2"},recordedTime(){return this.time&&this.recorder?.duration>=60*this.time&&this.toggleRecording(),g(this.recorder?.duration)}},beforeUnmount(){this.recording&&this.stopRecorder()},methods:{toggleRecording(){this.recording=!this.recording,this.recording?this.initRecorder():this.stopRecording()},initRecorder(){this.recorder=new m({micFailed:this.micFailed,bitRate:this.bitRate,sampleRate:this.sampleRate}),this.recorder.start(),this.successMessage=null,this.errorMessage=null,this.instructionMessage=b,this.service=new u(this.backendEndpoint)},stopRecording(){this.recorder.stop();const e=this.recorder.recordList();this.recordedAudio=e[0].url,this.recordedBlob=e[0].blob,this.recordedAudio&&(this.successMessage=w,this.instructionMessage=null),this.afterRecording&&(this.afterRecording(),this.sendData())},async sendData(){if(!this.recordedBlob)return;let e=null;e=this.customUpload?await this.customUpload(this.recordedBlob):await this.service.postBackend(this.recordedBlob),e?(this.errorMessage=null,this.successMessage=v,this.successfulUpload&&this.successfulUpload()):(this.successMessage=null,this.errorMessage=y,this.failedUpload&&this.failedUpload())},micFailed(){this.recording=!1,this.instructionMessage=f,this.errorMessage=R}}},x=i(262);const M=(0,x.A)(S,[["render",h]]);var k=M,U=k;return r=r["default"],r}()}));
//# sourceMappingURL=vue-audio-tapirus.umd.min.js.map